name: Dev Commit (Random Times & Monthly Quota)

on:
  schedule:
    - cron: "30 2-17 * * *"  # Runs at 8:30 AM to 11:30 PM Sri Lanka time (UTC+5:30)
  workflow_dispatch:

jobs:
  auto-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Grant write permission to the workflow

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT_TOKEN }}  # Use PAT from the start
          fetch-depth: 0

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}
          git_user_signingkey: true
          git_commit_gpgsign: true

      - name: Install jq and curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Select instruction file (frontend/backend)
        id: pickfile
        run: |
          FILES=("ai_instructions.json" "ai_instructions_backend.json")
          SELECTED_FILE=${FILES[$RANDOM % ${#FILES[@]}]}
          echo "SELECTED_FILE=$SELECTED_FILE" >> $GITHUB_ENV
          echo "Selected file: $SELECTED_FILE"

      - name: Read instructions
        id: read
        run: |
          RAW_JSON=$(cat $SELECTED_FILE)
          
          # Check if it's the backend file with nested structure
          if [[ "$SELECTED_FILE" == "ai_instructions_backend.json" ]]; then
            INSTRUCTIONS=$(echo "$RAW_JSON" | jq -c '.steps')
          else
            # Frontend file is already an array
            INSTRUCTIONS="$RAW_JSON"
          fi
          
          echo "INSTRUCTIONS_B64=$(echo "$INSTRUCTIONS" | base64 -w 0)" >> $GITHUB_ENV
          echo "Instructions extracted successfully"

      - name: Track progress and select uncompleted instruction
        id: progress
        run: |
          PROGRESS_FILE=".progress.json"
          
          # Create progress file if it doesn't exist
          if [ ! -f "$PROGRESS_FILE" ]; then
            echo '{"frontend_completed":[],"backend_completed":[]}' > $PROGRESS_FILE
          fi
          
          # Decode instructions
          INSTRUCTIONS=$(echo "$INSTRUCTIONS_B64" | base64 --decode)
          TOTAL_COUNT=$(echo "$INSTRUCTIONS" | jq length)
          
          # Determine which completion array to use
          if [[ "$SELECTED_FILE" == "ai_instructions_backend.json" ]]; then
            COMPLETED_KEY="backend_completed"
          else
            COMPLETED_KEY="frontend_completed"
          fi
          
          # Get completed instruction indices
          COMPLETED=$(jq -r ".$COMPLETED_KEY | @json" $PROGRESS_FILE)
          COMPLETED_ARRAY=$(echo "$COMPLETED" | jq -r '.[]' | tr '\n' ' ')
          
          # Find uncompleted instructions
          UNCOMPLETED=()
          for i in $(seq 0 $((TOTAL_COUNT - 1))); do
            if ! echo "$COMPLETED_ARRAY" | grep -qw "$i"; then
              UNCOMPLETED+=($i)
            fi
          done
          
          # If all completed, reset and start over
          if [ ${#UNCOMPLETED[@]} -eq 0 ]; then
            echo "All instructions completed! Resetting progress..."
            jq ".$COMPLETED_KEY = []" $PROGRESS_FILE > tmp_progress.$.json && mv tmp_progress.$.json $PROGRESS_FILE
            UNCOMPLETED=($(seq 0 $((TOTAL_COUNT - 1))))
          fi
          
          # Pick random uncompleted instruction
          RANDOM_UNCOMPLETED_INDEX=$((RANDOM % ${#UNCOMPLETED[@]}))
          SELECTED_INDEX=${UNCOMPLETED[$RANDOM_UNCOMPLETED_INDEX]}
          
          echo "SELECTED_INDEX=$SELECTED_INDEX" >> $GITHUB_ENV
          echo "COMPLETED_KEY=$COMPLETED_KEY" >> $GITHUB_ENV
          echo "Selected instruction index: $SELECTED_INDEX (${#UNCOMPLETED[@]} remaining)"

      - name: Setup daily quota
        run: |
          TODAY=$(date +%Y-%m-%d)
          QUOTA_FILE=".monthly_commit_quota.json"
          
          # Create quota file if it doesn't exist
          if [ ! -f "$QUOTA_FILE" ]; then
            echo '{}' > $QUOTA_FILE
          fi
          
          TODAY_DATA=$(jq -r ".\"$TODAY\"" $QUOTA_FILE)
          
          if [ "$TODAY_DATA" == "null" ]; then
            TODAY_DATA='{"commits_done":0,"commits_today_quota":3}'
            jq ". + {\"$TODAY\": $TODAY_DATA}" $QUOTA_FILE > tmp.$$.json && mv tmp.$$.json $QUOTA_FILE
          fi
          
          QUOTA=$(echo $TODAY_DATA | jq -r .commits_today_quota)
          DONE=$(echo $TODAY_DATA | jq -r .commits_done)
          
          echo "QUOTA=$QUOTA" >> $GITHUB_ENV
          echo "DONE=$DONE" >> $GITHUB_ENV
          echo "TODAY=$TODAY" >> $GITHUB_ENV
          echo "Today: $TODAY | Done: $DONE | Quota: $QUOTA"

      - name: Decide whether to commit this run
        id: randomcommit
        run: |
          if [ $DONE -ge $QUOTA ]; then
            echo "DO_COMMIT=false" >> $GITHUB_ENV
            echo "Quota reached for today ($DONE/$QUOTA)"
          else
            RANDOM_CHANCE=$((RANDOM % 100))
            if [ $RANDOM_CHANCE -lt 50 ]; then
              echo "DO_COMMIT=true" >> $GITHUB_ENV
              echo "Random check passed - will commit"
            else
              echo "DO_COMMIT=false" >> $GITHUB_ENV
              echo "Random check failed - skipping commit"
            fi
          fi

      - name: Run commit if selected
        if: env.DO_COMMIT == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          # Decode instructions
          INSTRUCTIONS=$(echo "$INSTRUCTIONS_B64" | base64 --decode)
          
          COUNT=$(echo "$INSTRUCTIONS" | jq length)
          INDEX=$((RANDOM % COUNT))
          STEP=$(echo "$INSTRUCTIONS" | jq -c .[$INDEX])
          
          # Extract fields - handle both frontend and backend structures
          if [[ "$SELECTED_FILE" == "ai_instructions_backend.json" ]]; then
            FILE_PATH=$(echo $STEP | jq -r '.output_files[0]')
            DESC=$(echo $STEP | jq -r .description)
            TITLE=$(echo $STEP | jq -r .title)
          else
            FILE_PATH=$(echo $STEP | jq -r .file)
            INSTRUCTION=$(echo $STEP | jq -r .instruction)
            
            # Generate natural commit title based on the instruction
            TITLE=$(echo "$INSTRUCTION" | sed 's/^Create /Add /' | sed 's/^Build /Implement /' | sed 's/^Design /Create /' | sed 's/\. .*$//')
            DESC="$INSTRUCTION"
          fi
          
          echo "Working on: $TITLE"
          echo "File: $FILE_PATH"
          
          # Call Gemini API
          RESPONSE=$(curl -s -X POST "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "{
              \"contents\": [{
                \"parts\": [{
                  \"text\": \"Write code for: $DESC. Output only valid code (React or Node.js depending on context). No explanations, no markdown code blocks, just raw code.\"
                }]
              }]
            }")
          
          CODE=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text')
          
          # Remove markdown code blocks if present
          CODE=$(echo "$CODE" | sed 's/^```[a-z]*\n//g' | sed 's/\n```$//g')
          
          # Create directory if needed
          if [ ! -f "$FILE_PATH" ]; then
            mkdir -p $(dirname "$FILE_PATH")
            echo "Created new file: $FILE_PATH"
          else
            echo "Updating existing file: $FILE_PATH"
          fi
          
          echo "$CODE" > "$FILE_PATH"
          
          # Configure git (GPG signing is already configured by import-gpg action)
          git config user.name "rasandu17"
          git config user.email "rasandu17@gmail.com"
          
          # Update commits_done counter BEFORE committing
          jq ".\"$TODAY\".commits_done += 1" .monthly_commit_quota.json > tmp.$.json && mv tmp.$.json .monthly_commit_quota.json
          
          # Add both the generated code AND the quota file in one commit
          git add "$FILE_PATH" .monthly_commit_quota.json
          
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "$TITLE" -m "$DESC"
          git push origin main
          
          echo "Successfully pushed changes"
